WITH t1 AS (
    SELECT 
        a.so, 
        a.item, 
        b.kpitem, 
        b.kpbc
    FROM isn a
    INNER JOIN mokp_d b 
        ON a.isn = b.isn 
        AND b.kpbc IN ('LD', 'MB', 'FPC', 'BO')
    WHERE a.so IN ('W001750195', 'W001747634')
),
ld AS (
    SELECT so, item, kpitem FROM t1 WHERE kpbc = 'LD'
),
mb AS (
    SELECT so, item, kpitem FROM t1 WHERE kpbc = 'MB'
),
fpc AS (
    SELECT so, item, kpitem FROM t1 WHERE kpbc = 'FPC'
),
bo AS (
    SELECT so, item, kpitem FROM t1 WHERE kpbc = 'BO'
),
combos AS (
    SELECT 
        ld.so,
        ld.item,
        ld.kpitem AS key1,
        mb.kpitem AS key2,
        fpc.kpitem AS key3,
        bo.kpitem AS key4
    FROM ld
    JOIN mb ON ld.so = mb.so AND ld.item = mb.item
    JOIN fpc ON ld.so = fpc.so AND ld.item = fpc.item
    JOIN bo ON ld.so = bo.so AND ld.item = bo.item
)
SELECT 
    combos.so,
    combos.item,
    kc.KEYID,
    kc.KEYINFO,
    kc.KEYVALUE1,
    kc.KEYVALUE2,
    kc.KEYVALUE3,
    kc.KEYVALUE4
FROM combos
JOIN key_config kc 
    ON kc.KEYVALUE1 = combos.key1
    AND kc.KEYVALUE2 = combos.key2
    AND kc.KEYVALUE3 = combos.key3
    AND kc.KEYVALUE4 = combos.key4
WHERE kc.KEYTYPE = 'CHK_AURA_SKU'
  AND kc.KEYID = combos.item
GROUP BY 
    combos.so,
    combos.item,
    kc.KEYID,
    kc.KEYINFO,
    kc.KEYVALUE1,
    kc.KEYVALUE2,
    kc.KEYVALUE3,
    kc.KEYVALUE4;
